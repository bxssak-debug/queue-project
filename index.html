<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyQueue - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow border-0 text-center">
                    <div class="card-body p-5">
                        <h2 class="card-title mb-4 text-primary">üè• ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>

                        <div class="mb-3 text-start">
                            <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control form-control-lg" id="patientName"
                                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
                        </div>

                        <div class="mb-4 text-start">
                            <label class="form-label fw-bold">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</label>
                            <select class="form-select form-select-lg" id="department">
                                <option value="general">‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                                <option value="dental">‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°</option>
                                <option value="ortho">‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠</option>
                            </select>
                        </div>

                        <button class="btn btn-primary btn-lg w-100 shadow-sm"
                            onclick="bookQueue()">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß</button>

                        <div id="resultBox" class="alert d-none mt-4 text-center shadow-sm" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import {
            getFirestore, collection, doc, runTransaction, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // ‡πÉ‡∏™‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
        const firebaseConfig = {
            apiKey: "AIzaSyDrc6ZDe5h8IMOpvUr7YP6heE8QgQZLjwA",
            authDomain: "easyqueue-ad588.firebaseapp.com",
            projectId: "easyqueue-ad588",
            storageBucket: "easyqueue-ad588.firebasestorage.app",
            messagingSenderId: "374878485971",
            appId: "1:374878485971:web:798a12b88248d213c50326"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DEPT_MAP = {
            general: { prefix: "G", label: "‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" },
            dental: { prefix: "D", label: "‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°" },
            ortho: { prefix: "O", label: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠" }
        };

        window.bookQueue = async function () {
            const btn = document.querySelector(".btn-primary");
            const nameInput = document.getElementById("patientName");
            const name = nameInput.value.trim();
            const deptKey = document.getElementById("department").value;
            const resultBox = document.getElementById("resultBox");

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            resultBox.className = "alert mt-4 text-center shadow-sm d-none";

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡πÑ‡∏´‡∏°
            if (name.length < 3) {
                resultBox.classList.remove("d-none");
                resultBox.classList.add("alert-danger");
                resultBox.innerHTML = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£";
                return;
            }

            // ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏∏‡∏ô‡πÇ‡∏´‡∏•‡∏î
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß...`;

            try {
                const dateKey = new Intl.DateTimeFormat('en-CA', {
                    timeZone: 'Asia/Bangkok'
                }).format(new Date());

                const counterRef = doc(db, "counters", `${deptKey}_${dateKey}`);
                const queueRef = doc(collection(db, "queues"));

                const displayNumber = await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    const nextNumber = (counterDoc.exists() ? counterDoc.data().currentNumber : 0) + 1;
                    const display = `${DEPT_MAP[deptKey].prefix}-${String(nextNumber).padStart(3, "0")}`;

                    transaction.set(counterRef, {
                        currentNumber: nextNumber,
                        department: deptKey,
                        date: dateKey,
                        lastUpdated: serverTimestamp()
                    }, { merge: true });

                    transaction.set(queueRef, {
                        queueNumber: nextNumber,
                        displayNumber: display,
                        name: name,
                        department: deptKey,
                        date: dateKey,
                        status: "waiting",
                        createdAt: serverTimestamp()
                    });

                    return display;
                });

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                resultBox.classList.remove("d-none");
                resultBox.classList.add("alert-success");
                resultBox.innerHTML = `
            <h4 class="mb-2">üéâ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h4>
            <p class="mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠</p>
            <h2 class="fw-bold text-success">${displayNumber}</h2>
            <p class="mb-0">‡πÅ‡∏ú‡∏ô‡∏Å: ${DEPT_MAP[deptKey].label}</p>
        `;

                nameInput.value = "";

            } catch (error) {
                console.error(error);
                resultBox.classList.remove("d-none");
                resultBox.classList.add("alert-danger");
                resultBox.innerHTML = "‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï";
            } finally {
                btn.disabled = false;
                btn.innerHTML = "‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß";
            }
        };
    </script>

</body>

</html>