<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyQueue - ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>

    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .card-queue {
            background-color: #2d2d2d;
            border: none;
            border-radius: 15px;
            transition: 0.3s;
        }

        .status-calling {
            border: 2px solid #ffc107;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
            transform: scale(1.02);
        }
    </style>
</head>

<body>

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üñ•Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà)</h2>
            <h5 id="dateDisplay" class="text-info"></h5>
        </div>

        <div class="row" id="queueList"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            onSnapshot,
            doc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrc6ZDe5h8IMOpvUr7YP6heE8QgQZLjwA",
            authDomain: "easyqueue-ad588.firebaseapp.com",
            projectId: "easyqueue-ad588",
            storageBucket: "easyqueue-ad588.firebasestorage.app",
            messagingSenderId: "374878485971",
            appId: "1:374878485971:web:798a12b88248d213c50326"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DEPT_MAP = {
            general: "‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
            dental: "‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°",
            ortho: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠"
        };

        function getThaiDateKey() {
            return new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Bangkok'
            }).format(new Date());
        }

        const todayKey = getThaiDateKey();
        document.getElementById('dateDisplay').innerText = `‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${todayKey}`;

        function loadDashboard() {
            const q = query(
                collection(db, "queues"),
                where("date", "==", todayKey),
                where("status", "in", ["waiting", "calling"])
            );

            onSnapshot(q, (snapshot) => {
                const queueList = document.getElementById("queueList");
                queueList.innerHTML = "";

                if (snapshot.empty) {
                    queueList.innerHTML =
                        `<div class="col-12 text-center text-secondary mt-5">
                            <h4>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
                        </div>`;
                    return;
                }

                let queues = [];
                snapshot.forEach(docSnap =>
                    queues.push({ id: docSnap.id, ...docSnap.data() })
                );

                queues.sort((a, b) => a.queueNumber - b.queueNumber);

                queues.forEach(data => {
                    const isCalling = data.status === "calling";
                    const deptNameThai = DEPT_MAP[data.department] || data.department;

                    queueList.innerHTML += `
                        <div class="col-md-4 mb-4">
                            <div class="card card-queue p-3 ${isCalling ? 'status-calling' : ''}">
                                <div class="card-body text-center">
                                    <span class="badge ${isCalling ? 'bg-warning text-dark' : 'bg-info text-dark'} mb-2 fs-6">
                                        ${deptNameThai}
                                    </span>

                                    <h1 class="display-3 fw-bold text-${isCalling ? 'warning' : 'primary'} my-3">
                                        ${data.displayNumber}
                                    </h1>

                                    <h4 class="mb-4 text-light">${data.name}</h4>

                                    <div class="d-grid gap-2">
                                        ${!isCalling
                            ? `<button class="btn btn-warning btn-lg fw-bold"
                                onclick="updateStatus('${data.id}', 'calling', '${data.displayNumber}', '${deptNameThai}', '${data.name}')">
                                üîä ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß
                               </button>`
                            : `<button class="btn btn-success btn-lg fw-bold"
                                onclick="updateStatus('${data.id}', 'completed')">
                                ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                               </button>`
                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // üîä ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß (‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)
        window.speakQueue = function (queueNumber, deptName, patientName) {
            const readableQueue = queueNumber.split('-').join(' ');
            const textToSpeak =
                `‡∏Ç‡∏≠‡πÄ‡∏ä‡∏¥‡∏ç‡∏Ñ‡∏∏‡∏ì ${patientName}, ‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${readableQueue}, ‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏Å ${deptName} ‡∏Ñ‡πà‡∏∞`;

            if (window.responsiveVoice) {
                responsiveVoice.cancel(); // ‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≠‡∏ô
                responsiveVoice.speak(textToSpeak, "Thai Female", {
                    rate: 0.8,
                    pitch: 1.1
                });
            }
        };

        window.updateStatus = async function (
            docId,
            newStatus,
            queueNumber = '',
            deptName = '',
            patientName = ''
        ) {
            try {
                if (newStatus === 'calling') {
                    speakQueue(queueNumber, deptName, patientName);
                }

                await updateDoc(doc(db, "queues", docId), {
                    status: newStatus
                });

            } catch (error) {
                console.error("Error updating status: ", error);
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            }
        };

        loadDashboard();
    </script>

</body>

</html>